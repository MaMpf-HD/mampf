# ðŸ”— See also
# https://kamal-deploy.org/docs/
# https://jetthoughts.com/blog/kamal-2.0-complete-rails-deployment-guide-deploy-without-heroku-in-2025/
# https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/app/templates/config/deploy.yml.tt

# ðŸŽˆ Create a `kamal` user on the server:
# https://nts.strzibny.name/using-non-root-users-kamal/
# Replace `username` by `kamal` in the following.
#
# useradd --create-home username
# usermod -s /bin/bash username
#
# su - username -c 'mkdir -p ~/.ssh'
# su - username -c 'touch ~/.ssh/authorized_keys'
# Add your SSH public key to the new user's authorized_keys file. Then:
# chmod 700 /home/username/.ssh
# chmod 600 /home/username/.ssh/authorized_keys
#
# echo 'username ALL=(ALL:ALL) NOPASSWD: ALL' | tee /etc/sudoers.d/username
# chmod 0440 /etc/sudoers.d/username
# visudo -c -f /etc/sudoers.d/username

# The following command can only be run after docker is installed.
# Kamal installs docker automatically when you run `kamal setup`.
# Afterwards, you will get permission denied errors on the docker.sock.
# To fix those, add the user to the docker group:
# usermod -aG docker username

# ðŸŽˆ Folders
# see config/initializers/shrine.rb
# Create some storage folders on the server & make the `kamal` user the owner:
# server and make the `kamal` user the owner:
# sudo mkdir -p /mnt/caches/medien_uploads /mnt/media /mnt/submissions/cache /mnt/submissions/store
# sudo chown -R kamal:kamal /mnt/caches/medien_uploads /mnt/media /mnt/submissions/cache /mnt/submissions/store

# ðŸŽˆ Only allow users to login via ssh keys, not passwords
# https://itsfoss.gitlab.io/post/disable-ssh-password-authentication-for-specific-user-or-group/
# sudo nano /etc/ssh/sshd_config
# Set `PasswordAuthentication no`
# Then restart the ssh service:
# sudo systemctl restart sshd

# ðŸŽˆ Create a GitHub Access Token (classic)
# see https://kurtpeniket.co.uk/blog/kamal_with_ghcr
# Use that one in the .env file as `KAMAL_REGISTRY_PASSWORD`.

# ðŸŽˆ Deploy
# bundle exec dotenv kamal setup
# bundle exec dotenv kamal accessory boot all
# bundle exec dotenv kamal deploy

service: mampf
image: splines/mampf

servers:
  web:
    hosts:
      - 91.98.178.89
    labels:
      de.uni-heidelberg.mathi.mampf.container-type: master
    options:
      entrypoint: /usr/src/app/docker/production/entrypoint-master.sh
  
  worker:
    hosts:
      - 91.98.178.89
    labels:
      de.uni-heidelberg.mathi.mampf.container-type: worker
    options:
      entrypoint: /usr/src/app/docker/production/entrypoint-worker.sh

proxy:
  ssl: true
  host: mampf.media
  app_port: 3000

registry:
  server: ghcr.io
  username: splines
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64
  dockerfile:
    docker/production/Dockerfile

env:
  clear:
    BLOG: https://mampf.blog
    MEDIA_SERVER: https://media.mathi.uni-heidelberg.de
    MUESLI_SERVER: https://muesli.mathi.uni-heidelberg.de
    MEMCACHED_SERVER: cache
    MAX_DELETIONS_PER_RUN: 50
    FROM_ADDRESS: mampf@mathi.uni-heidelberg.de
    MAILSERVER: mail.mathi.uni-heidelberg.de
    PROJECT_EMAIL: mampf@mathi.uni-heidelberg.de
    MAILID_DOMAIN: mathi.uni-heidelberg.de
    ERROR_EMAIL: mampf-error@mathi.uni-heidelberg.de
    IMAPSERVER: mail.mathi.uni-heidelberg.de
    PROJECT_EMAIL_MAILBOX: "Other Users/mampf"
    FEEDBACK_EMAIL: mampf-feedback-email
    DOWNLOAD_LOCATION: https://mampf.mathi.uni-heidelberg.de/mediaforward
    REWRITE_ENABLED: 1
    USE_CAPTCHA_SERVICE: 1
    CAPTCHA_VERIFY_URL: https://captcha2go.mathi.uni-heidelberg.de/v1/verify
    CAPTCHA_PUZZLE_URL: https://captcha2go.mathi.uni-heidelberg.de/v1/puzzle
    MEDIA_PATH: /private/media
    SUBMISSION_PATH: /private/submissions
    PRODUCTION_DATABASE_ADAPTER: postgresql
    PRODUCTION_DATABASE_DATABASE: mampf
    PRODUCTION_DATABASE_INTERACTIONS: mampf_interactions
    RAILS_ENV: production
    URL_HOST: mampf.mathi.uni-heidelberg.de
    MAMPF_PORT: 3000
    REDIS_URL: redis://redis:6379/0
    RAILS_SERVE_STATIC_FILES: true
    RAILS_LOG_TO_STDOUT: true
  secret:
    - RAILS_MASTER_KEY
    - SECRET_KEY_BASE
    - PROJECT_NOTIFICATION_EMAIL
    - PROJECT_EMAIL_USERNAME
    - PROJECT_EMAIL_PASSWORD
    - MAMPF_EMAIL_USERNAME
    - MAMPF_EMAIL_PASSWORD
    - CAPTCHA_APPLICATION_TOKEN
    - PRODUCTION_DATABASE_URL

# Aliases are triggered with "bin/kamal <alias>". You can overwrite arguments on invocation:
# "bin/kamal app logs -r job" will tail logs from the first server in the job section.
#
# aliases:
#   shell: app exec --interactive --reuse "bash"

ssh:
  user: kamal

volumes:
  - /mnt/media:/private/media
  - /mnt/submissions:/private/submissions
  - /mnt/caches:/caches
  - public:/usr/src/app/public

# for asset bridging across deploys
asset_path: /usr/src/app/public/assets

accessories:
  # https://railsboilerplate.com/articles/how-to-configure-postgres-accessory-kamal-2-rails-8
  db:
    image: postgres:17-bookworm
    host: 91.98.178.89
    env:
      clear:
        POSTGRES_DB: mampf
        DB_HOST: 127.0.0.1
      # https://hub.docker.com/_/postgres/#environment-variables
      secret:
        - POSTGRES_USER
        - POSTGRES_PASSWORD
        # used in production-init.sh script
        - DB_MAMPFUSER_PASSWORD
        - PGPORT
    files:
      - db/production-init.sh:/docker-entrypoint-initdb.d/setup.sh
    directories:
      - data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine
    host: 91.98.178.89

  cache:
    image: memcached:alpine
    host: 91.98.178.89

  nginx:
    image: openresty/openresty:alpine
    host: 91.98.178.89
    port: "127.0.0.1:3000:80"
    volumes:
      - nginx-conf-d:/etc/nginx/conf.d
    options:
      # Until https://github.com/nginx-proxy/docker-gen/pull/311 is merged, use hardcoded name
      name: mampf-docker-proxy

  dockergen:
    image: nginxproxy/docker-gen
    host: 91.98.178.89
    cmd: -notify-sighup mampf-docker-proxy -watch /etc/docker-gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf
