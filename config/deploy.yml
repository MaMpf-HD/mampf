# ðŸ”— See also
# https://kamal-deploy.org/docs/
# https://jetthoughts.com/blog/kamal-2.0-complete-rails-deployment-guide-deploy-without-heroku-in-2025/
# https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/app/templates/config/deploy.yml.tt

# ðŸŽˆ Create a `kamal` user on the server:
# https://nts.strzibny.name/using-non-root-users-kamal/
#
# useradd --create-home username
# usermod -s /bin/bash username
#
# su - username -c 'mkdir -p ~/.ssh'
# su - username -c 'touch ~/.ssh/authorized_keys'
# Add your SSH public key to the new user's authorized_keys file. Then:
# chmod 700 /home/username/.ssh
# chmod 600 /home/username/.ssh/authorized_keys
#
# echo 'username ALL=(ALL:ALL) NOPASSWD: ALL' | tee /etc/sudoers.d/username
# chmod 0440 /etc/sudoers.d/username
# visudo -c -f /etc/sudoers.d/username
# usermod -aG docker username

# ðŸŽˆ Create a GitHub Access Token (classic)
# see https://kurtpeniket.co.uk/blog/kamal_with_ghcr

service: mampf
image: splines/mampf

servers:
  web:
    hosts:
      - 91.98.178.89
    labels:
      de.uni-heidelberg.mathi.mampf.container-type: master
    options:
      network: "mampf"
    cmd: /usr/src/app/docker/production/entrypoint-master.sh
  
  worker:
    hosts:
      - 91.98.178.89
    count: 3
    labels:
      de.uni-heidelberg.mathi.mampf.container-type: worker
    options:
      network: "mampf"
    cmd: /usr/src/app/docker/production/entrypoint-worker.sh

proxy:
  ssl: true
  host: mampf.media
  app_port: 3000

registry:
  server: ghcr.io
  username: splines
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64
  dockerfile:
    docker/production/Dockerfile
  # Pass in additional build args needed for your Dockerfile.
  # args:
  #   RUBY_VERSION: <%= ENV["RBENV_VERSION"] || ENV["rvm_ruby_string"] || "#{RUBY_ENGINE}-#{RUBY_ENGINE_VERSION}" %>

# Inject ENV variables into containers (secrets come from .kamal/secrets).
#
# env:
#   clear:
#     DB_HOST: mampf-db
#   secret:
#     - RAILS_MASTER_KEY

# Aliases are triggered with "bin/kamal <alias>". You can overwrite arguments on invocation:
# "bin/kamal app logs -r job" will tail logs from the first server in the job section.
#
# aliases:
#   shell: app exec --interactive --reuse "bash"

ssh:
  user: kamal

# Use a persistent storage volume.
#
# volumes:
#   - "app_storage:/app/storage"

# Bridge fingerprinted assets, like JS and CSS, between versions to avoid
# hitting 404 on in-flight requests. Combines all files from new and old
# version inside the asset_path.
#
# asset_path: /app/public/assets

# Configure rolling deploys by setting a wait time between batches of restarts.
#
# boot:
#   limit: 10 # Can also specify as a percentage of total hosts, such as "25%"
#   wait: 2

# Use accessory services (secrets come from .kamal/secrets).
#
# accessories:
#   db:
#     image: mysql:8.0
#     host: 192.168.0.2
#     port: "127.0.0.1:3306:3306"
#     env:
#       clear:
#         MYSQL_ROOT_HOST: '%'
#       secret:
#         - MYSQL_ROOT_PASSWORD
#     files:
#       - config/mysql/production.cnf:/etc/mysql/my.cnf
#       - db/production.sql:/docker-entrypoint-initdb.d/setup.sql
#     directories:
#       - data:/var/lib/mysql
#   redis:
#     image: valkey/valkey:8
#     host: 192.168.0.2
#     port: 6379
#     directories:
#       - data:/data
