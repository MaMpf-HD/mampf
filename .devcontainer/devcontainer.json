// adapted from https://github.com/rails/rails/tree/main/.devcontainer
// For format details, see https://containers.dev/implementors/json_reference/.

// For ssh-related issues on WSL, see
// https://github.com/microsoft/vscode-remote-release/issues/8666#issuecomment-2986483634
// basically, add this to your ~/.profile inside WSL:
// if [ -z "$SSH_AUTH_SOCK" ]; then
//   eval "$(ssh-agent -s)"
//   ssh-add ~/.ssh/your_github_key
// fi
// 
// for pure-Windows users (no WSL), see this instead:
// https://github.com/microsoft/vscode-remote-release/issues/11043#issuecomment-3005677524

{
    "name": "MaMpf development",
    "dockerComposeFile": [
        "../docker/development/docker-compose.yml",
        "compose.devcontainer.yml"
    ],
    "service": "mampf",
    // https://github.com/orgs/community/discussions/15506
    "workspaceFolder": "/usr/src/app/",
    // https://containers.dev/features.
    "features": {
        "ghcr.io/devcontainers/features/github-cli:1": {
            "version": "latest"
        },
        "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {}
    },
    "containerEnv": {
        "SHELL": "/bin/bash"
    },
    // Use 'forwardPorts' to make a list of ports inside the container available locally.
    // This can be used to network with other containers or the host.
    "forwardPorts": [
        3000, // Rails app (via nginx)
        3036, // Vite dev server
        1080, // Mailcatcher web interface
        5050, // pgAdmin
        13254 // Ruby debugger
    ],
    "portsAttributes": {
        "3000": {
            "label": "MaMpf App",
            "onAutoForward": "notify"
        },
        "3036": {
            "label": "Vite Dev Server",
            "onAutoForward": "silent"
        },
        "1080": {
            "label": "Mailcatcher",
            "onAutoForward": "silent"
        },
        "5050": {
            "label": "pgAdmin",
            "onAutoForward": "silent"
        },
        "13254": {
            "label": "Ruby Debug",
            "onAutoForward": "silent"
        }
    },
    "postStartCommand": "./docker/entrypoint-dev-test.sh | tee /proc/1/fd/1",
    "customizations": {
        "vscode": {
            "extensions": [
                // Ruby extensions
                "Shopify.ruby-lsp",
                // JavaScript/Node extensions
                "dbaeumer.vscode-eslint",
                // Other useful extensions
                "streetsidesoftware.code-spell-checker",
                "streetsidesoftware.code-spell-checker-german",
                "nefrob.vscode-just-syntax"
            ]
        }
    },
    "overrideCommand": true, // see docker-compose.devcontainer.yml
    "remoteUser": "mampf"
}