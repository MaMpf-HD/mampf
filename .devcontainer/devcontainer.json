// adapted from https://github.com/rails/rails/tree/main/.devcontainer
// For format details, see https://containers.dev/implementors/json_reference/.
//
// For ssh-related issues on WSL, see
// https://github.com/microsoft/vscode-remote-release/issues/8666#issuecomment-2986483634
// basically, add this to your ~/.profile inside WSL:
// if [ -z "$SSH_AUTH_SOCK" ]; then
//   eval "$(ssh-agent -s)"
//   ssh-add ~/.ssh/your_github_key
// fi
// 
// for pure-Windows users (no WSL), see this instead:
// https://github.com/microsoft/vscode-remote-release/issues/11043#issuecomment-3005677524
{
    "name": "MaMpf development",
    "dockerComposeFile": [
        "../docker/development/compose.yml",
        "compose.devcontainer.yml"
    ],
    "service": "mampf",
    // https://github.com/orgs/community/discussions/15506
    "workspaceFolder": "/workspaces/mampf/",
    // https://containers.dev/features
    "features": {
        "ghcr.io/devcontainers/features/github-cli:1": {
            "version": "latest"
        },
        "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {},
        "ghcr.io/jsburckhardt/devcontainer-features/just:1": {},
        "ghcr.io/mikaello/devcontainer-features/modern-shell-utils:2": {}
    },
    "containerEnv": {
        // in the container itself, we then install zsh
        // (this just serves as a fallback)
        "SHELL": "/bin/bash"
    },
    // Use 'forwardPorts' to make a list of ports inside the container available locally.
    // This can be used to network with other containers or the host.
    "forwardPorts": [
        3000, // MaMpf App
        3145, // MaMpf App for Cypress tests
        3036, // Vite server
        3037, // Vite server for Cypress tests
        1080, // Mailcatcher web interface
        5050, // pgAdmin
        8061 // desktop (cypress)
    ],
    "portsAttributes": {
        // Main app
        "3000": {
            "label": "MaMpf App",
            "onAutoForward": "openBrowserOnce"
        },
        "3036": {
            "label": "Vite Server",
            "onAutoForward": "silent"
        },
        "5050": {
            "label": "pgAdmin",
            "onAutoForward": "silent"
        },
        // Test ports (for Cypress)
        "3145": {
            "label": "MaMpf App for Cypress tests",
            "onAutoForward": "silent"
        },
        "3037": {
            "label": "Vite Test Server",
            "onAutoForward": "silent"
        },
        "8061": {
            "label": "Cypress",
            "onAutoForward": "openBrowserOnce"
        },
        // Miscellaneous
        "1080": {
            "label": "mailcatcher",
            "onAutoForward": "silent"
        }
    },
    "initializeCommand": "git submodule update --init --recursive",
    "postCreateCommand": ".devcontainer/boot.sh",
    "customizations": {
        "vscode": {
            "extensions": [
                // Ruby extensions
                "Shopify.ruby-lsp",
                // JavaScript/Node extensions
                "dbaeumer.vscode-eslint",
                // Other useful extensions
                "streetsidesoftware.code-spell-checker",
                "streetsidesoftware.code-spell-checker-german",
                "nefrob.vscode-just-syntax",
                "timonwong.shellcheck"
            ]
        }
    },
    "overrideCommand": true, // see docker-compose.devcontainer.yml
    "remoteUser": "mampf"
}