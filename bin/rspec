#!/usr/bin/env ruby

require "pathname"

DOCKER_COMPOSE_FOLDER = File.expand_path("../../docker/test", __FILE__)
DOCKER_SERVICE_NAME = "mampf"
PROJECT_ROOT = File.expand_path("../..", __FILE__)
DOCKER_PROJECT_ROOT = "/usr/src/app"

def get_container_id
  container_id = `cd #{DOCKER_COMPOSE_FOLDER} && docker compose ps -q #{DOCKER_SERVICE_NAME}`.strip
  
  if container_id.empty?
    puts "\nError: The #{DOCKER_SERVICE_NAME} test container is not running."
    puts "\nPlease start it first by running:"
    puts "  cd docker/test && docker compose up -d #{DOCKER_SERVICE_NAME}"
    puts "\nOr from the project root:"
    puts "  docker compose -f docker/test/docker-compose.yml up -d #{DOCKER_SERVICE_NAME}"
    exit 1
    exit 1
  end
  
  container_id
end

def map_path_to_docker(path)
  return path unless path.start_with?(PROJECT_ROOT)

  path.sub(PROJECT_ROOT, DOCKER_PROJECT_ROOT)
end

def get_docker_formatter_path(container_id)
  gem_path = `docker exec #{container_id} sh -c "gem which ruby-lsp-rspec 2>/dev/null"`.strip
  return nil if gem_path.empty?
  
  gem_dir = File.dirname(gem_path)
  "#{gem_dir}/ruby_lsp/ruby_lsp_rspec/rspec_formatter.rb"
end

def map_args_to_docker(args, container_id)
  docker_formatter_path = nil
  mapped_args = []
  i = 0
  
  while i < args.length
    arg = args[i]
    
    if (arg == "-r" || arg == "--require") && i + 1 < args.length
      next_arg = args[i + 1]
      if next_arg.include?("ruby_lsp_rspec") && next_arg.include?("rspec_formatter.rb")
        docker_formatter_path ||= get_docker_formatter_path(container_id)
        if docker_formatter_path
          mapped_args << arg
          mapped_args << docker_formatter_path
          i += 2
          next
        else
          puts "Could not find ruby-lsp-rspec gem inside the container (needed to load the formatter)."
          puts "Please install the gem inside the container (run bundle install inside the container)."
          exit 1
        end
      end
    end
    
    mapped_args << map_path_to_docker(arg)
    i += 1
  end
  
  mapped_args
end

def main
  container_id = get_container_id
  docker_args = map_args_to_docker(ARGV, container_id)
  rspec_args = docker_args.join(' ')
  rspec_command = "RAILS_ENV=test bundle exec rspec #{rspec_args}"
  # puts "Running command in Docker container #{container_id}: #{rspec_command}"

  flags = STDOUT.tty? ? ["-it"] : ["-i"]
  status = system("docker", "exec", *flags, container_id, "sh", "-c", rspec_command)
  exit_code = $?.exitstatus || (status ? 0 : 1)
  exit exit_code
end

main
