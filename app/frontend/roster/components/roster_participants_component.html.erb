<div class="row">
  <div class="col-12">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <%= t("roster.tabs.participants") %>
          <span class="badge bg-secondary ms-2"><%= @counts[:total] || 0 %></span>
          <%= helpers.helpdesk(t("roster.participants_footer_hint"), false) %>
        </h5>

        <!-- Filter Toggle Buttons -->
        <div class="btn-group btn-group-sm" role="group">
          <%= link_to lecture_roster_path(@lecture, tab: :participants, filter: :all, group_type: @group_type),
                      class: "btn btn-outline-secondary #{'active' if @filter_mode == 'all'}",
                      data: { turbo_action: "advance" } do %>
            <%= t('roster.filters.all') %> (<span><%= @counts[:total] || 0 %></span>)
          <% end %>

          <%= link_to lecture_roster_path(@lecture, tab: :participants, filter: :unassigned, group_type: @group_type),
                      class: "btn btn-outline-secondary #{'active' if @filter_mode == 'unassigned'}",
                      data: { turbo_action: "advance" } do %>
            <%= t('roster.filters.unassigned') %> (<span><%= @counts[:unassigned] || 0 %></span>)
          <% end %>
        </div>
      </div>

      <div class="card-body p-0">
        <% if (nav = pagination_nav) %>
          <div class="d-flex justify-content-center py-2 border-bottom">
            <%== nav %>
          </div>
        <% end %>

        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col"><%= t("basics.name") %></th>
                <th scope="col"><%= t("basics.email") %></th>
                <th scope="col"><%= t("roster.columns.groups") %></th>
                <th scope="col" class="text-end"><%= t("basics.actions") %></th>
              </tr>
            </thead>
            <tbody>
              <% if participants.empty? %>
                <tr>
                  <td colspan="4" class="text-center py-4 text-muted">
                    <%= t("roster.details.empty") %>
                  </td>
                </tr>
              <% else %>
                <% participants.each do |membership| %>
                  <% user = membership.user %>
                  <tr data-cy="participant-row-<%= user.id %>">
                    <td>
                      <div class="fw-bold"><%= user.tutorial_name %></div>
                      <small class="text-muted"><%= user.email %></small>
                    </td>
                    <td><%= user.email %></td>
                    <td>
                      <% groups = participant_groups(user) %>
                      <% if groups.any? %>
                        <% groups.each do |group| %>
                          <%= helpers.roster_group_badge(group, group_type) %>
                        <% end %>
                      <% else %>
                        <span class="text-muted small"><%= t("roster.stats.status_unassigned") %></span>
                      <% end %>
                    </td>
                    <td class="text-end">
                      <div class="d-flex justify-content-end gap-2">
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-popper-config='{"strategy":"fixed"}'>
                            <%= t('roster.actions.assign') %>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <% available = available_groups_for(user) %>
                            <% if available.any? %>
                              <% available.group_by { |g| g.model_name.human(count: 2) }.sort.each do |type, groups| %>
                                <li><h6 class="dropdown-header"><%= type %></h6></li>
                                <% groups.each do |group| %>
                                  <% actions = assignment_actions(user, group) %>
                                  <% actions.each do |action| %>
                                    <li>
                                      <%= button_to action[:url],
                                          method: action[:method],
                                          params: action[:params].merge(active_tab: "participants",
                                                                      group_type: group_type,
                                                                      page: @pagy.page,
                                                                      frame_id: helpers.roster_maintenance_frame_id(group_type)),
                                          data: { turbo_confirm: (t("roster.warnings.confirm_overbooking") if group.full?) },
                                          class: "dropdown-item d-flex justify-content-between align-items-center" do %>
                                        <span>
                                          <i class="bi bi-<%= action[:icon] %> me-1"></i>
                                          <%= action[:label] %>
                                        </span>
                                        <small class="text-muted"><%= group.roster_entries.size %>/<%= group.capacity || "âˆž" %></small>
                                      <% end %>
                                    </li>
                                  <% end %>
                                <% end %>
                              <% end %>
                            <% else %>
                              <li><span class="dropdown-item disabled fst-italic"><%= t('roster.details.empty') %></span></li>
                            <% end %>
                          </ul>
                        </div>

                        <%= button_to helpers.remove_member_lecture_path(lecture, user),
                                      method: :delete,
                                      params: { active_tab: "participants",
                                                group_type: group_type,
                                                page: @pagy.page,
                                                frame_id: helpers.roster_maintenance_frame_id(group_type) },
                                      class: "btn btn-sm btn-outline-danger",
                                      title: t('roster.tooltips.kick_from_lecture'),
                                      data: { bs_toggle: "tooltip",
                                              turbo_confirm: t('roster.warnings.confirm_kick_from_lecture') } do %>
                          <i class="bi bi-trash"></i>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <% if (nav = pagination_nav) %>
        <div class="card-footer d-flex justify-content-center">
          <%== nav %>
        </div>
      <% end %>
    </div>
  </div>
</div>
