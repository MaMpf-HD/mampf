<div class="card h-100">
  <div class="card-header">
    <h5 class="card-title mb-0">
      <%= t('roster.candidates.title') %>
      <span class="badge bg-secondary rounded-pill ms-2"><%= candidates.count %></span>
      <%= helpers.helpdesk(t('roster.candidates.help'), false) %>
    </h5>
  </div>
  <div class="card-body p-0">
    <% if grouped_candidates.any? %>
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th><%= t('roster.columns.name') %></th>
              <th><%= t('roster.columns.email') %></th>
              <th><%= t('roster.columns.preferences') %></th>
              <th class="text-end"><%= t('roster.columns.actions') %></th>
            </tr>
          </thead>
          <% grouped_candidates.each do |group| %>
            <% if grouped_candidates.size > 1 %>
              <tbody class="border-0">
                <tr class="bg-secondary text-white">
                  <th colspan="4" class="ps-3 bg-secondary text-white">
                    <h6 class="mb-0 fw-bold"><%= t("registration.item.groups.#{group[:type]}") %></h6>
                  </th>
                </tr>
              </tbody>
            <% end %>

            <% [
                 { users: fresh_candidates(group[:users]), id: nil },
                 { users: previously_assigned_candidates(group[:users]), id: "previouslyAssignedCollapse-#{group[:type]}" }
               ].each do |subgroup| %>
              <% next if subgroup[:users].empty? %>

              <% if subgroup[:id] %>
                <tbody class="border-top-0">
                  <tr class="bg-light">
                    <td colspan="4" class="p-0">
                      <button class="btn btn-link btn-sm text-decoration-none w-100 text-start p-2 text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#<%= subgroup[:id] %>" aria-expanded="false" aria-controls="<%= subgroup[:id] %>">
                        <i class="bi bi-chevron-down me-1"></i>
                        <%= t('roster.candidates.show_previously_assigned', count: subgroup[:users].count) %>
                      </button>
                    </td>
                  </tr>
                </tbody>
                <tbody class="collapse" id="<%= subgroup[:id] %>">
              <% else %>
                <tbody>
              <% end %>

              <% subgroup[:users].each do |user| %>
                <tr>
                  <td class="fw-medium">
                    <%= user.name %>
                    <% if previously_assigned?(user) %>
                      <span class="badge bg-warning text-dark ms-1" title="<%= t('roster.candidates.previously_assigned_tooltip') %>" data-bs-toggle="tooltip">
                        <i class="bi bi-arrow-counterclockwise"></i>
                      </span>
                    <% end %>
                  </td>
                  <td class="text-muted"><%= user.email %></td>
                  <td>
                    <% candidate_info(user).each do |info| %>
                      <div class="small">
                        <span class="fw-bold"><%= info[:campaign_title] %>:</span>
                        <% if info[:wishes].present? %>
                          <span class="text-truncate d-inline-block align-bottom" style="max-width: 300px;" title="<%= info[:wishes] %>">
                            <%= info[:wishes] %>
                          </span>
                        <% else %>
                          <span class="fst-italic text-muted"><%= t('roster.candidates.no_prefs') %></span>
                        <% end %>
                      </div>
                    <% end %>
                  </td>
                  <td class="text-end">
                    <div class="dropdown">
                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-boundary="viewport" data-bs-popper-config='{"strategy":"fixed"}'>
                        <%= t('roster.actions.assign') %>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header"><%= t('roster.actions.assign_to') %></h6></li>
                        <% if transfer_targets.any? %>
                          <% transfer_targets.each do |target_group| %>
                            <li><h6 class="dropdown-header"><%= target_group[:title] %></h6></li>
                            <% target_group[:items].each do |target| %>
                              <li>
                                <%= link_to target[:title],
                                    add_member_path(target[:group], user),
                                    data: { turbo_method: :post, turbo_confirm: (t('roster.warnings.confirm_overbooking') if target[:overbooked]) },
                                    class: "dropdown-item" %>
                              </li>
                            <% end %>
                          <% end %>
                        <% else %>
                          <li><span class="dropdown-item disabled"><%= t('roster.details.empty') %></span></li>
                        <% end %>
                      </ul>
                    </div>
                  </td>
                </tr>
              <% end %>
              </tbody>
            <% end %>
          <% end %>
        </table>
      </div>
    <% else %>
      <div class="p-4 text-center text-muted">
        <i class="bi bi-check-circle display-6 mb-3"></i>
        <p class="mb-0"><%= t('roster.candidates.empty') %></p>
      </div>
    <% end %>
  </div>
</div>
