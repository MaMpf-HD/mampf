<%= turbo_frame_tag "registration_campaigns_content" do %>
  <div class="mb-3">
    <%= link_to lecture_registration_campaigns_path(@campaign.campaignable),
                data: { turbo_frame: "registration_campaigns_content" },
                class: "btn btn-sm btn-outline-secondary" do %>
      <i class="bi bi-arrow-left"></i> <%= t("back") %>
    <% end %>
  </div>
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3><%= @campaign.title %></h3>
    <div class="d-flex gap-2">
      <% if @campaign.open? %>
        <%= button_to t("registration.campaign.actions.close"),
                      close_registration_campaign_path(@campaign),
                      method: :patch,
                      class: "btn btn-warning" %>
      <% elsif @campaign.closed? %>
        <%= button_to t("registration.campaign.actions.reopen"),
                      reopen_registration_campaign_path(@campaign),
                      method: :patch,
                      class: "btn btn-success" %>
      <% else %>
        <%= button_to t("registration.campaign.actions.open"),
                      open_registration_campaign_path(@campaign),
                      method: :patch,
                      class: "btn btn-success" %>
      <% end %>

      <% if @campaign.can_be_deleted? %>
        <%= button_to t("buttons.delete"),
                      registration_campaign_path(@campaign),
                      method: :delete,
                      data: { confirm: t("registration.campaign.confirm_delete", default: "Are you sure?") },
                      class: "btn btn-outline-danger" %>
      <% end %>
    </div>
  </div>

  <ul class="nav nav-tabs mb-3" id="campaignTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true"><%= t("basics.overview") %></button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false"><%= t("basics.settings", default: "Settings") %></button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="policies-tab" data-bs-toggle="tab" data-bs-target="#policies" type="button" role="tab" aria-controls="policies" aria-selected="false"><%= t("registration.policy.index.title") %></button>
    </li>
  </ul>

  <div class="tab-content" id="campaignTabsContent">
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="row g-3 mb-3">
        <div class="col-12 col-lg-8">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-3 text-muted"><%= t("basics.details") %></h6>
              <dl class="row mb-0">
                <dt class="col-sm-4"><%= t("registration.campaign.form.title") %></dt>
                <dd class="col-sm-8"><%= @campaign.title %></dd>

                <dt class="col-sm-4"><%= t("registration.campaign.form.allocation_mode") %></dt>
                <dd class="col-sm-8"><%= @campaign.allocation_mode.humanize %></dd>

                <dt class="col-sm-4"><%= t("registration.campaign.form.registration_deadline") %></dt>
                <dd class="col-sm-8"><%= l(@campaign.registration_deadline, format: :long) if @campaign.registration_deadline %></dd>

                <dt class="col-sm-4"><%= t("basics.status") %></dt>
                <dd class="col-sm-8">
                  <span class="badge bg-<%= @campaign.open? ? 'success' : (@campaign.closed? ? 'secondary' : 'warning') %>">
                    <%= t("registration.campaign.status.#{@campaign.status}") %>
                  </span>
                </dd>
              </dl>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted"><%= t("registration.campaign.overview.registrations") %></h6>
              <% confirmed_count = @campaign.user_registrations.where(status: :confirmed).count %>
              <% pending_count = @campaign.user_registrations.where(status: :pending).count %>
              <% rejected_count = @campaign.user_registrations.where(status: :rejected).count %>
              <% total_count = confirmed_count + pending_count + rejected_count %>
              
              <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="fw-semibold"><%= t("registration.campaign.overview.total") %></div>
                <span class="badge rounded-pill text-bg-success"><%= t("registration.campaign.overview.confirmed_count", count: confirmed_count) %></span>
              </div>
              <div class="small text-muted mb-2">
                <%= t("registration.campaign.overview.pending_count", count: pending_count) %> Â· 
                <%= t("registration.campaign.overview.rejected_count", count: rejected_count) %>
              </div>
              <% if total_count > 0 %>
                <div class="progress" style="height:6px;">
                  <div class="progress-bar bg-success" style="width: <%= (confirmed_count.to_f / total_count * 100).round %>%"></div>
                  <div class="progress-bar bg-warning" style="width: <%= (pending_count.to_f / total_count * 100).round %>%"></div>
                  <div class="progress-bar bg-danger" style="width: <%= (rejected_count.to_f / total_count * 100).round %>%"></div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <div class="card">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted"><%= t("registration.campaign.overview.items") %></h6>
              <div class="fw-semibold"><%= @campaign.registration_items.count %></div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted"><%= t("registration.policy.index.title") %></h6>
              <div class="fw-semibold"><%= @campaign.registration_policies.count %></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
      <%= render "form", campaign: @campaign, lecture: @campaign.campaignable %>
    </div>

    <div class="tab-pane fade" id="policies" role="tabpanel" aria-labelledby="policies-tab">
      <%= render "registration/policies/index" %>
    </div>
  </div>
<% end %>
