<% service = registration_items_service(campaign) %>
<% available_items = service.items %>

<div class="card mb-4">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" id="add-items-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="existing-tab" data-bs-toggle="tab" data-bs-target="#existing" type="button" role="tab" aria-controls="existing" aria-selected="true">
          <%= t("registration.item.add.existing") %>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="new-tab" data-bs-toggle="tab" data-bs-target="#new" type="button" role="tab" aria-controls="new" aria-selected="false">
          <%= t("registration.item.add.new") %>
        </button>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content" id="add-items-content">
      <div class="tab-pane fade show active" id="existing" role="tabpanel" aria-labelledby="existing-tab">
        <% if available_items.empty? %>
          <div class="alert alert-secondary mb-0">
            <%= t("registration.item.add.none_available") %>
          </div>
        <% else %>
          <div class="row g-4">
            <% if available_items[:tutorials].present? %>
              <div class="col-12">
                <h6><%= t("registration.item.groups.tutorials") %></h6>
                <div class="list-group">
                  <% available_items[:tutorials].each do |tutorial| %>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <%= tutorial.title_with_tutors %>
                        <span class="badge bg-secondary ms-2">
                          <%= format_capacity(tutorial.capacity) %>
                        </span>
                      </div>
                      <%= button_to t("basics.add"),
                                    registration_campaign_items_path(campaign),
                                    params: { registration_item: { registerable_id: tutorial.id, registerable_type: "Tutorial" } },
                                    class: "btn btn-sm btn-primary",
                                    data: { turbo: true } %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if available_items[:talks].present? %>
              <div class="col-12">
                <h6><%= t("registration.item.groups.talks") %></h6>
                <div class="list-group">
                  <% available_items[:talks].each do |talk| %>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <%= talk.to_label %>
                        <% if talk.speakers.any? %>
                          <span class="text-muted ms-2">(<%= speaker_list(talk) %>)</span>
                        <% end %>
                      </div>
                      <%= button_to t("basics.add"),
                                    registration_campaign_items_path(campaign),
                                    params: { registration_item: { registerable_id: talk.id, registerable_type: "Talk" } },
                                    class: "btn btn-sm btn-primary",
                                    data: { turbo: true } %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if available_items[:cohorts].present? %>
              <div class="col-12">
                <h6><%= t("registration.item.groups.cohorts") %></h6>
                <div class="list-group">
                  <% available_items[:cohorts].each do |cohort| %>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <%= cohort.title %>
                        <span class="badge bg-secondary ms-2">
                          <%= format_capacity(cohort.capacity) %>
                        </span>
                      </div>
                      <%= button_to t("basics.add"),
                                    registration_campaign_items_path(campaign),
                                    params: { registration_item: { registerable_id: cohort.id, registerable_type: "Cohort" } },
                                    class: "btn btn-sm btn-primary",
                                    data: { turbo: true } %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      <div class="tab-pane fade" id="new" role="tabpanel" aria-labelledby="new-tab">
        <%
          options = service.creatable_types.map do |type|
            [t("registration.item.types.#{type.parameterize.underscore}"), type]
          end
        %>
        <%= form_with url: registration_campaign_items_path(campaign), 
                      method: :post, 
                      data: { 
                        turbo: true,
                        controller: "registerable-type-help cohort-purpose",
                        registerable_type_help_tutorial_help_value: t("registration.item.help.tutorial"),
                        registerable_type_help_talk_help_value: t("registration.item.help.talk"),
                        registerable_type_help_enrollment_help_value: t("registration.item.help.enrollment"),
                        registerable_type_help_planning_help_value: t("registration.item.help.planning"),
                        registerable_type_help_other_help_value: t("registration.item.help.other")
                      } do |f| %>
          <%= f.hidden_field "registration_item[new_registerable]", value: "true" %>

          <div class="row g-3">
            <div class="col-md-12">
              <%= f.label "registration_item[registerable_type]", t("basics.type"), class: "form-label" %>
              <%= f.select "registration_item[registerable_type]", 
                          options, 
                          { prompt: t("registration.item.select_type") }, 
                          class: "form-select",
                          data: { 
                            registerable_type_help_target: "select",
                            cohort_purpose_target: "typeSelect",
                            action: "change->registerable-type-help#updateHelp change->cohort-purpose#togglePurpose"
                          } %>
              <small class="form-text text-muted mt-2" 
                     data-registerable-type-help-target="helpText"
                     style="display: none;"></small>
            </div>
          </div>

          <%= f.hidden_field "registration_item[purpose]", 
                            data: { cohort_purpose_target: "purposeField" } %>

          <div class="row g-3 mt-2" 
               data-cohort-purpose-target="propagateContainer"
               style="display: none;">
            <div class="col-md-12">
              <div class="form-check">
                <%= f.check_box "registration_item[propagate_to_lecture]", 
                                class: "form-check-input",
                                checked: true,
                                data: { cohort_purpose_target: "propagateCheckbox" } %>
                <%= f.label "registration_item[propagate_to_lecture]", 
                            t("registration.item.attributes.propagate_to_lecture"),
                            class: "form-check-label" %>
              </div>
              <small class="form-text text-muted">
                <%= t("registration.item.help.propagate_to_lecture") %>
              </small>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <%= f.label "registration_item[title]", t("basics.title"), class: "form-label" %>
              <%= f.text_field "registration_item[title]", class: "form-control", required: true %>
            </div>

            <div class="col-md-4">
              <%= f.label "registration_item[capacity]", t("registration.item.attributes.capacity_optional"), class: "form-label" %>
              <%= f.number_field "registration_item[capacity]", class: "form-control", min: 1, placeholder: "âˆž" %>
            </div>

            <div class="col-md-2 d-flex align-items-end">
              <%= f.submit t("buttons.create"), class: "btn btn-primary w-100" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
