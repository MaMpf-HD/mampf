<%= stylesheet_link_tag 'vignettes-take' %>
<%= javascript_include_tag 'vignettes/take_questionnaire' %>

<!-- Info Slide Modals -->
<% @slide.info_slides.each_with_index do |info_slide, index| %>
    <%= render partial: 'vignettes/info_slides/take_modal',
                        locals: { index: index, info_slide: info_slide } %>
<% end %>

<!-- Slide -->
<%= form_with(model: @answer, id: "answer_form",
              url: submit_answer_vignettes_questionnaire_url(@questionnaire),
              local: true) do |form| %>

<div id="vignette-take-card" class="container-md small-width card">

    <div class="slide-header text-light">
        <!-- TODO: add a proper user-defined slide title -->
        <!-- TODO: add a marker where the user currently is, e.g. (1/5) -->
        <h4 class="mb-0"> Slide <%= @slide.position %></h4>
    </div>

    <!-- Info Slides -->
    <div class="card-body">
        Additional information:

        <% @slide.info_slides.each_with_index do |info_slide, index| %>
            <!-- TODO: if really needed, add back the possibility for an "image" button -->
            <!-- via the class info-slide-icon-button -->
            <button type="button" class="btn" title="Find information about: <%= info_slide.title %>"
                    data-bs-toggle="modal" data-bs-target="#vignette-info-slide-modal-<%= index %>">
                <i class="bi bi-info-circle-fill"></i>
                <%= info_slide.title %>
            </button>
        <% end %>

    </div>

    <div class="card-body">

        <!-- Main Slide Content -->
        <div id="current-slide-container" data-slide-id="<%= @slide.id %>" data-questionnaire-id="<%= @questionnaire.id %>" >
            <%= @slide.content %>
            <%= @slide.question.question_text %>

            <br>

            <%= form.hidden_field :slide_id, value: @slide.id %>

                <%= form.fields_for :slide_statistic do |stat_form| %>
                    <%= stat_form.hidden_field :user_id, value: current_user.id %>
                    <%= stat_form.hidden_field :time_on_slide, id: "time-on-slide-field" %>
                    <%= stat_form.hidden_field :time_on_info_slides, id: "time-on-info-slides-field" %>
                    <%= stat_form.hidden_field :info_slides_access_count, id:"info-slides-access-count-field" %>
                <% end %>

                <% case @slide.question.type %> 
                    <% when "Vignettes::TextQuestion" %>
                        <%= form.label :text, "Your Answer" %>
                        <%= form.text_area :text %>
                    <% when "Vignettes::MultipleChoiceQuestion" %>
                        <% @slide.question.options.each do |option| %>
                            <%= option.text %>
                            <%= check_box_tag "vignettes_answer[option_ids][]", option.id, @answer.option_ids.include?(option.id) %>
                        <% end %>
                    <% when "Vignettes::LikertScaleQuestion" %>
                        <% Vignettes::LikertScaleQuestion::LIKERT_LABELS.each do |value, label| %>
                        <div>
                            <%= form.radio_button :likert_scale_value, value %>
                            <%= form.label :likert_scale_value, label %>
                        </div>
                        <% end %>
                <br>
                        
            <% end %>
        </div>

    </div>

    <!-- Navigation Controls for Slide -->
    <div class="card-footer d-flex justify-content-end">
        <% if @slide.question.type == "" %>
            <%= form.submit "Next Slide", class: "slide-footer-btn" %>
        <% else %>
            <%= form.submit "Submit answer", class: "slide-footer-btn" %>
        <% end %>
    </div>

</div>

<% end %>
