<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15/Sortable.min.js"></script>
<%= javascript_include_tag 'vignettes/edit' %>
<%=stylesheet_link_tag 'vignettes-edit' %>

<div class="container-md small-width">
    <div id="vignette-edit-header">
        <h1 class="fs-3 fw-bold">
            <%= @questionnaire.title%>
        </h1>

        <!-- Action Items -->
        <div class="d-flex">
            <%= button_to preview_questionnaire_path(@questionnaire),
                :disabled => @questionnaire.slides.empty?,
                class: "btn btn-outline-primary me-2",
                method: :get do %>
                <i class="bi bi-eye"></i>
                Preview
            <% end %>

            <% unless @questionnaire.published %>
            <button type="button" class="btn btn-outline-primary me-2"
                    data-bs-toggle="modal" data-bs-target="#publishModal">
                <i class="bi bi-globe-europe-africa"></i>
                Publish
            </button>
            <% else %>
            <span class="btn btn-success disabled me-2">Published</span>
            <% end %>

            <button type="button" class="btn btn-outline-secondary me-2"
                    data-bs-toggle="modal" data-bs-target="#duplicateModal">
                <i class="bi bi-files"></i>
                Duplicate
            </button>

            <%= button_to export_answers_questionnaire_path(@questionnaire),
                class: 'btn btn-outline-secondary me-2',
                method: :get do %>
                <i class="bi bi-file-earmark-spreadsheet"></i>
                Export Answers
            <% end %>

            <button type="button" class="btn btn-outline-danger"
                    data-bs-toggle="modal" data-bs-target="#deleteQuestionnaireModal">
                <i class="bi bi-trash"></i>
                <%= t("vignettes.delete") %>
            </button>
        </div>
    </div>

    <!-- Info Slides -->
    <h2 class="fs-4 fw-bold mt-4 mb-0">Info Slides</h1>
    <ul>
        <% @questionnaire.info_slides.each() do |info_slide| %>
        <li>
            <%= link_to info_slide.title, edit_questionnaire_info_slide_path(@questionnaire, info_slide) %>
        </li>
        <% end %>
    </ul>

    <!-- new_questionnaire_info_slide_path(@questionnaire) -->
    <button type="button"
            class="btn btn-outline-primary mt-2" 
            <%= 'disabled' if @questionnaire.published %>
            >
        <i class="bi bi-plus-circle"></i>
        Add new info slide
    </button>

    <!-- Slides -->
    <h2 class="fs-4 fw-bold mt-4 mb-0">Slides</h1>
    <% if @slides.size > 1 %>
    <p>Drag the slides to change their order.</p>
    <% end %>

    <!-- Add this before the accordion -->
    <div id="unsaved-changes-warning" class="alert alert-warning d-none">
      <i class="bi bi-exclamation-triangle"></i> You have unsaved changes. Please save your changes before navigating away.
    </div>

    <div class="accordion" id="vignettes-slides-accordion"
         data-questionnaire-id="<%= @questionnaire.id %>"
         data-questionnaire-published="<%= @questionnaire.published %>">
        <% @slides.each() do |slide| %>
            <%= render partial: "slide_accordion_item", locals: { slide: slide } %>
        <% end %>
    </div>

    <!-- Add new slide (at the end of the list) -->
    <button type="button" id="vignettes-new-slide-btn" 
            class="btn btn-outline-primary mt-2" 
            <%= 'disabled' if @questionnaire.published %>
            >
        <i class="bi bi-plus-circle"></i>
        Add new slide
    </button>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteQuestionnaireModal" tabindex="-1" aria-labelledby="deleteQuestionnaireModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteQuestionnaireModalLabel">
            <%= t("vignettes.delete") %>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><%= t("vignettes.confirm_delete") %></p>
      </div>
      <div class="modal-footer">
        <%= button_to t("vignettes.delete"), 
          questionnaire_path(@questionnaire),
          method: :delete,
          class: "btn btn-danger"
          %>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <%= t("buttons.cancel") %>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Publish Confirmation Modal -->
<div class="modal fade" id="publishModal" tabindex="-1" aria-labelledby="publishModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="publishModalLabel">Confirm Publication</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- TO DO: Write better message -->
        <p>After publishing, you can only change typos and nothing else</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <%= button_to "Publish", 
              publish_questionnaire_path(@questionnaire),
              method: :patch,
              class: "btn btn-primary"
        %>
      </div>
    </div>
  </div>
</div>

<!-- Duplicate Modal -->
<div class="modal fade" id="duplicateModal" tabindex="-1" aria-labelledby="duplicateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="duplicateModalLabel">Duplicate Questionnaire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with url: duplicate_questionnaire_path(@questionnaire), method: :post do |form| %>
        <div class="modal-body">
          <div class="mb-3">
            <label for="duplicateQuestionnaireTitle" class="form-label">New questionnaire title</label>
            <input type="text" class="form-control" id="duplicateQuestionnaireTitle" name="title" 
                   value="Copy of <%= @questionnaire.title %>" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Duplicate</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Unsaved Changes Modal -->
<div class="modal fade" id="unsaved-changes-modal" tabindex="-1" aria-labelledby="unsavedChangesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="unsavedChangesModalLabel">Unsaved Changes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>You have unsaved changes in the current slide. Do you want to save or discard them before editing a new one?</p>
      </div>
      <div class="modal-footer">
        <button type="button" id="save-changes-btn" class="btn btn-primary">Save Changes</button>
        <button type="button" id="discard-changes-btn" class="btn btn-secondary">Discard Changes</button>
      </div>
    </div>
  </div>
</div>