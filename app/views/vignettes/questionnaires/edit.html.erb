<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15/Sortable.min.js"></script>
<%= javascript_include_tag 'vignettes/edit' %>

<div class="container-md small-width">
    <!-- Slides -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="fs-4 fw-bold mb-0">Slides</h1>
        
        <% unless @questionnaire.published %>
            <button type="button" 
                    class="btn btn-primary"
                    data-bs-toggle="modal" 
                    data-bs-target="#publishModal">
                Publish
            </button>
        <% else %>
            <span class="btn btn-success disabled">Published</span>
        <% end %>
    </div>

	<% if @slides.size > 1 %>
		<p>Drag the slides to change their order.</p>
	<% end %>

    <div class="accordion" id="vignettes-slides-accordion"
         data-questionnaire-id="<%= @questionnaire.id %>">
        <% @slides.each() do |slide| %>
            <%= render partial: "slide_accordion_item", locals: { slide: slide } %>
        <% end %>
    </div>

    <!-- Add new slide (at the end of the list) -->
    <button type="button" id="vignettes-new-slide-btn" 
            class="btn btn-outline-primary mt-2" 
            <%= 'disabled' if @questionnaire.published %>
            >
        <i class="bi bi-plus-circle"></i>
        Add new slide
    </button>

    <br>
    <br>
    <br>
    <br>

    <!-- Info Slides -->
    <h1 class="vignette-edit-header">Info slides</h1>
    <ul>
        <% @questionnaire.info_slides.each() do |info_slide| %>
            <li>
                <%= link_to info_slide.title, edit_questionnaire_info_slide_path(@questionnaire, info_slide) %>
            </li>
        <%end%>
    </ul>
    <%= button_to 'Create new info slide', new_questionnaire_info_slide_path(@questionnaire), method: :get, class: 'btn btn-primary' %>

    <!-- Export -->
    <%= button_to "Export answers", export_answers_questionnaire_path(@questionnaire), method: :get, class: 'btn btn-primary' %>
</div>

<div class="mt-5 border-top pt-4">
  <div class="d-flex justify-content-between align-items-center">
    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteQuestionnaireModal">
      Delete Questionnaire
    </button>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteQuestionnaireModal" tabindex="-1" aria-labelledby="deleteQuestionnaireModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteQuestionnaireModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><%= t("vignettes.questionnaire_confirm_delete") %></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <%= button_to "Delete Questionnaire", 
              questionnaire_path(@questionnaire),
              method: :delete,
              class: "btn btn-danger"
        %>
      </div>
    </div>
  </div>
</div>

<!-- Publish Confirmation Modal -->
<div class="modal fade" id="publishModal" tabindex="-1" aria-labelledby="publishModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="publishModalLabel">Confirm Publication</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- TO DO: Write better message -->
        <p>After publishing, you can only change typos and nothing else</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <%= button_to "Publish", 
              publish_questionnaire_path(@questionnaire),
              method: :patch,
              class: "btn btn-primary"
        %>
      </div>
    </div>
  </div>
</div>
