<%= form_with model: cohort,
              id: dom_id(cohort, "form"),
              data: {
                turbo: true,
                controller: "capacity-guard cohort-purpose-hierarchical",
                action: "submit->capacity-guard#submit",
                capacity_guard_current_count_value: cohort.members.count,
                capacity_guard_original_capacity_value: cohort.capacity || 0,
                capacity_guard_confirm_message_value: t("roster.warnings.capacity_reduction")
              } do |f| %>
  <%= f.hidden_field :lecture_id, value: cohort.context.id %>
  <%= hidden_group_type_field(params[:group_type]) %>
  <div class="modal-body">
    <% 
      # Determine propagate value from context (dropdown) or existing cohort
      if cohort.persisted?
        propagates = cohort.propagate_to_lecture?
      else
        propagate_flag = params.dig(:cohort, :propagate_to_lecture)
        propagates = propagate_flag.to_s == "true"
      end
    %>
    
    <%# Show context info header - always present since users come from dropdown or edit %>
    <div class="alert alert-info d-flex align-items-start mb-3">
      <i class="bi bi-info-circle-fill me-2 mt-1"></i>
      <div>
        <strong>
          <%= t("roster.group_category.flexible_group") %>
          <%= propagates ? "(#{t("roster.cohorts.with_lecture_enrollment_title")})" : "(#{t("roster.cohorts.without_lecture_enrollment_title")})" %>
        </strong>
        <br>
        <small class="text-muted">
          <%= propagates ? t("roster.cohorts.with_lecture_enrollment_help") : t("roster.cohorts.without_lecture_enrollment_help") %>
          <br><strong><%= t("roster.cohorts.help.propagate_readonly_warning") %></strong>
        </small>
      </div>
    </div>
    <%= f.hidden_field :propagate_to_lecture %>
    <%= hidden_field_tag :group_category, "Flexible Group" unless cohort.persisted? %>

    <% 
      # Determine which semantic flag applies based on propagate context
      special_purpose = propagates ? "enrollment" : "planning"
      special_purpose_label = t("roster.cohorts.help.#{special_purpose}_checkbox_label")
      
      # Check if cohort has special purpose set
      current_purpose = cohort.purpose.to_s.presence || "general"
      has_special_purpose = current_purpose == special_purpose
    %>

    <div class="mb-3">
      <label class="form-label">
        <%= t("roster.cohorts.help.semantic_purpose_label") %>
      </label>
      <small class="form-text text-muted d-block mb-2">
        <%= t("roster.cohorts.help.semantic_purpose_explanation") %>
      </small>
      
      <div class="form-check">
        <%= check_box_tag :has_special_purpose,
                          "1",
                          has_special_purpose,
                          class: "form-check-input",
                          data: {
                            cohort_purpose_hierarchical_target: "purposeCheckbox",
                            action: "change->cohort-purpose-hierarchical#togglePurpose"
                          } %>
        <%= label_tag :has_special_purpose, special_purpose_label, class: "form-check-label" %>
      </div>

      <% if propagates && (cohort.context.tutorials.any? || cohort.context.talks.any?) %>
        <div class="alert alert-warning d-flex align-items-start mt-2 mb-0 py-2" 
             data-cohort-purpose-hierarchical-target="enrollmentWarning"
             style="display: <%= has_special_purpose ? 'flex' : 'none' %>;">
          <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
          <small><%= t("roster.cohorts.help.enrollment_warning") %></small>
        </div>
      <% end %>
    </div>

    <div class="mb-3">
      <%= f.label :title, t("basics.title"), class: "form-label" %>
      <%= f.text_field :title, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :description, t("basics.description"), class: "form-label" %>
      <%= helpdesk(t("roster.hints.cohort_description"), false) %>
      <%= f.text_area :description, class: "form-control", rows: 3 %>
    </div>

    <div class="mb-3">
      <%= f.label :capacity, t("basics.capacity"), class: "form-label" %>
      <%= f.number_field :capacity,
            class: "form-control",
            min: 0,
            placeholder: "âˆž",
            data: { capacity_guard_target: "input" } %>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t("buttons.cancel") %></button>
    <%= f.submit t("buttons.save"), class: "btn btn-primary" %>
  </div>
<% end %>
